<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чек-лист УЗ-мониторинга</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      padding-top: 60px;     /* место под таймер */
      padding-bottom: 200px; /* место под клавиатуру */
      background-color: #f4f4f4;
    }
    .timer {
      position: fixed; top:0; left:0; right:0;
      background:#0088cc; color:#fff;
      text-align:center; padding:10px 0;
      font-size:18px; font-weight:bold;
      z-index:1000;
    }
    .hidden { display:none }
    .section {
      background:#fff; padding:15px;
      border-radius:8px; margin-bottom:20px;
    }
    h2,h3 { margin-top:0 }
    label { display:block; margin:8px 0 4px }
    input, select { width:100%; padding:8px; margin-bottom:12px; box-sizing:border-box }
    button {
      padding:10px 20px; margin:6px 4px 0 0;
      border:none; border-radius:5px;
      background:#0088cc; color:#fff;
      font-size:16px; cursor:pointer;
    }
    button.secondary { background:#666 }
    p.result { font-weight:bold; margin:4px 0 12px }
  </style>
</head>
<body>
  <div id="timer" class="timer hidden">00:00</div>

  <!-- Шаг 1 -->
  <div id="step1" class="section">
    <h2>Исходные данные</h2>
    <label>Выберите блок:</label>
    <select id="block_select">
      <option value="1">Блок 1</option>
      <option value="2">Блок 2</option>
      <option value="3">Блок 3</option>
      <option value="4">Блок 4</option>
      <option value="5">Блок 5 (УЗИ лёгких)</option>
      <option value="6">Блок 6 (Полный протокол)</option>
    </select>
    <label>Номер И/Б (ID пациента):</label>
    <input type="text" id="patient_id" placeholder="ID пациента">
    <label>Возраст пациента:</label>
    <input type="number" id="patient_age" placeholder="Лет">
    <button id="next1">Далее</button>
  </div>

  <!-- Форма Блока 1 -->
  <div id="form1" class="section hidden">
    <h2>Блок 1: IJV, CCA, Flow</h2>
    <h3>Вариабельность диаметра внутренней яремной вены</h3>
    <label>Max (мм):<input id="ven1_max" type="number" step="0.1"></label>
    <label>Min (мм):<input id="ven1_min" type="number" step="0.1"></label>
    <p id="ven1_ratio" class="result"></p>
    <label><input id="ven1_err" type="checkbox"> Тех. погрешности</label>

    <h3>Вариабельность диаметра общей сонной артерии</h3>
    <label>Max (мм):<input id="cca1_max" type="number" step="0.1"></label>
    <label>Min (мм):<input id="cca1_min" type="number" step="0.1"></label>
    <p id="cca1_ratio" class="result"></p>
    <label><input id="cca1_err" type="checkbox"> Тех. погрешности</label>

    <h3>Корректированное время потока</h3>
    <label>Время (мс):<input id="flow1_time" type="number" step="0.1"></label>
    <label>ЧСС:<input id="hr1" type="number"></label>
    <p id="flow1_corr" class="result"></p>
    <label><input id="flow1_err" type="checkbox"> Тех. погрешности</label>

    <button class="secondary back" data-from="1">Назад</button>
    <button class="submit" data-block="1">Завершить</button>
  </div>

  <!-- Форма Блока 2 -->
  <div id="form2" class="section hidden">
    <h2>Блок 2: Блок 1 + Brachial, IVC</h2>
    <!-- IJV -->
    <h3>Вариабельность внутренней яремной вены</h3>
    <label>Max:<input id="ven2_max" type="number" step="0.1"></label>
    <label>Min:<input id="ven2_min" type="number" step="0.1"></label>
    <p id="ven2_ratio" class="result"></p>
    <label><input id="ven2_err" type="checkbox"> Тех. погрешности</label>
    <!-- CCA -->
    <h3>Вариабельность общей сонной артерии</h3>
    <label>Max:<input id="cca2_max" type="number" step="0.1"></label>
    <label>Min:<input id="cca2_min" type="number" step="0.1"></label>
    <p id="cca2_ratio" class="result"></p>
    <label><input id="cca2_err" type="checkbox"> Тех. погрешности</label>
    <!-- Flow -->
    <h3>Корректированное время потока</h3>
    <label>Время:<input id="flow2_time" type="number" step="0.1"></label>
    <label>ЧСС:<input id="hr2" type="number"></label>
    <p id="flow2_corr" class="result"></p>
    <label><input id="flow2_err" type="checkbox"> Тех. погрешности</label>
    <!-- Brachial -->
    <h3>Вариабельность плечевой артерии</h3>
    <label>Max (см/с):<input id="brach2_max" type="number" step="0.1"></label>
    <label>Min (см/с):<input id="brach2_min" type="number" step="0.1"></label>
    <p id="brach2_ratio" class="result"></p>
    <label><input id="brach2_err" type="checkbox"> Тех. погрешности</label>
    <!-- IVC -->
    <h3>Вариабельность нижней полой вены</h3>
    <label>Max:<input id="ivc2_max" type="number" step="0.1"></label>
    <label>Min:<input id="ivc2_min" type="number" step="0.1"></label>
    <p id="ivc2_ratio" class="result"></p>
    <label><input id="ivc2_err" type="checkbox"> Тех. погрешности</label>

    <button class="secondary back" data-from="2">Назад</button>
    <button class="submit" data-block="2">Завершить</button>
  </div>

  <!-- Форма Блока 3 -->
  <div id="form3" class="section hidden">
    <h2>Блок 3: VTI LVOT и VTI PA</h2>
    <h3>VTI на выносящем тракте ЛЖ</h3>
    <label>Max:<input id="lvot3_max" type="number" step="0.1"></label>
    <label>Min:<input id="lvot3_min" type="number" step="0.1"></label>
    <p id="lvot3_ratio" class="result"></p>
    <label><input id="lvot3_err" type="checkbox"> Тех. погрешности</label>
    <h3>VTI на легочной артерии</h3>
    <label>Max:<input id="pa3_max" type="number" step="0.1"></label>
    <label>Min:<input id="pa3_min" type="number" step="0.1"></label>
    <p id="pa3_ratio" class="result"></p>
    <label><input id="pa3_err" type="checkbox"> Тех. погрешности</label>

    <button class="secondary back" data-from="3">Назад</button>
    <button class="submit" data-block="3">Завершить</button>
  </div>

  <!-- Форма Блока 4 -->
  <div id="form4" class="section hidden">
    <h2>Блок 4: Объединённый</h2>
    <!-- Повтор всех полей из блоков 1,2,3 -->
    <!-- (используйте id=“ven4_max”…, “cca4_max”…, “flow4_time”, “brach4_max”, “ivc4_max”, “lvot4_max”, “pa4_max” и соответствующие min, err и выводы) -->

    <button class="secondary back" data-from="4">Назад</button>
    <button class="submit" data-block="4">Завершить</button>
  </div>

  <!-- Форма Блока 5 -->
  <div id="form5" class="section hidden">
    <h2>Блок 5: УЗИ лёгких</h2>
    <h3>Справа</h3>
    <label>Зона 1:<select id="lus_r1"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 2:<select id="lus_r2"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 3:<select id="lus_r3"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 4:<select id="lus_r4"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 5:<select id="lus_r5"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 6:<select id="lus_r6"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label><input id="lus_r_cons" type="checkbox"> Субплевральные консолидации</label>
    <label><input id="lus_r_pneumo" type="checkbox"> Пневмоторакс</label>
    <label><input id="lus_r_hydro" type="checkbox"> Гидроторакс</label>

    <h3>Слева</h3>
    <label>Зона 1:<select id="lus_l1"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 2:<select id="lus_l2"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 3:<select id="lus_l3"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 4:<select id="lus_l4"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 5:<select id="lus_l5"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label>Зона 6:<select id="lus_l6"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <label><input id="lus_l_cons" type="checkbox"> Субплевральные консолидации</label>
    <label><input id="lus_l_pneumo" type="checkbox"> Пневмоторакс</label>
    <label><input id="lus_l_hydro" type="checkbox"> Гидроторакс</label>

    <label><input id="lus5_err" type="checkbox"> Тех. погрешности</label>
    <p id="lus_score" class="result"></p>

    <button class="secondary back" data-from="5">Назад</button>
    <button class="submit" data-block="5">Завершить</button>
  </div>

  <!-- Форма Блока 6 -->
  <div id="form6" class="section hidden">
    <h2>Блок 6: Полный протокол</h2>
    <!-- все поля из form4 -->
    <!-- … ваш HTML из form4 … -->

    <!-- затем повтор форм5 -->
    <h3>Справа</h3>
    <label>Зона 1:<select id="lus6_r1"><option>0</option><option>1</option><option>2</option><option>3</option></select></label>
    <!-- … зоны 2–6 … -->
    <label><input id="lus6_r_cons" type="checkbox"> Субплевральные консолидации</label>
    <label><input id="lus6_r_pneumo" type="checkbox"> Пневмоторакс</label>
    <label><input id="lus6_r_hydro" type="checkbox"> Гидроторакс</label>

    <h3>Слева</h3>
    <!-- зоны 1–6 … -->
    <label><input id="lus6_l_cons" type="checkbox"> Субплевральные консолидации</label>
    <label><input id="lus6_l_pneumo" type="checkbox"> Пневмоторакс</label>
    <label><input id="lus6_l_hydro" type="checkbox"> Гидроторакс</label>

    <label><input id="lus6_err" type="checkbox"> Тех. погрешности</label>
    <p id="lus6_score" class="result"></p>

    <button class="secondary back" data-from="6">Назад</button>
    <button class="submit" data-block="6">Завершить</button>
  </div>

 <script>
  document.addEventListener('DOMContentLoaded', () => {
    const webApp = Telegram.WebApp;
    webApp.ready();

    const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzfl5Ppyupn82FOZRPlgxgZ0XvC9OV8BQxapAumrWtkh7Bxi7IBVmfEiseXahgQVjmM/exec';
    const formData = {};
    let timerInterval, startTime;

    // Таймер
    function startTimer() {
      startTime = Date.now();
      document.getElementById('timer').classList.remove('hidden');
      timerInterval = setInterval(() => {
        const sec = Math.floor((Date.now() - startTime) / 1000),
              m = String(Math.floor(sec / 60)).padStart(2,'0'),
              s = String(sec % 60).padStart(2,'0');
        document.getElementById('timer').textContent = `${m}:${s}`;
      }, 1000);
    }
    function stopTimer() {
      clearInterval(timerInterval);
      formData.total_time = Math.floor((Date.now() - startTime) / 1000);
    }

    // Шаг 1 → форма
    document.getElementById('next1').addEventListener('click', () => {
      formData.block      = document.getElementById('block_select').value;
      formData.patient_id = document.getElementById('patient_id').value.trim();
      formData.age        = parseInt(document.getElementById('patient_age').value, 10);
      if (!formData.patient_id || isNaN(formData.age)) {
        alert('Заполните все поля');
        return;
      }
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('form' + formData.block).classList.remove('hidden');
      startTimer();
    });

    // Кнопки Назад
    document.querySelectorAll('.back').forEach(btn => {
      btn.addEventListener('click', () => {
        const from = btn.dataset.from;
        document.getElementById('form' + from).classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
        clearInterval(timerInterval);
        document.getElementById('timer').classList.add('hidden');
      });
    });

    // Привязка расчёта процентов (пример для IJV, остальные аналогично)
    function bindRatio(maxId, minId, resId, fMax, fMin, fRatio, cutoffText) {
      function update() {
        const mx = parseFloat(document.getElementById(maxId).value),
              mn = parseFloat(document.getElementById(minId).value);
        if (!isNaN(mx) && !isNaN(mn)) {
          const r = (mx - mn) / ((mx + mn) / 2) * 100;
          document.getElementById(resId).textContent = r.toFixed(1) + '% ' + cutoffText;
          formData[fMax]   = mx;
          formData[fMin]   = mn;
          formData[fRatio] = r;
        }
      }
      document.getElementById(maxId).addEventListener('input', update);
      document.getElementById(minId).addEventListener('input', update);
    }

    // Привяжем, например, блок 1:
    bindRatio('ven1_max','ven1_min','ven1_ratio','b1_ven_max','b1_ven_min','b1_ven_ratio','(отсечка 18%)');
    bindRatio('cca1_max','cca1_min','cca1_ratio','b1_cca_max','b1_cca_min','b1_cca_ratio','(отсечка 12%)');
    document.getElementById('flow1_time').addEventListener('input', () => {
      const t  = parseFloat(document.getElementById('flow1_time').value),
            hr = parseInt(document.getElementById('hr1').value, 10);
      if (!isNaN(t) && !isNaN(hr)) {
        const corr = t + 1.3 * (hr - 60),
              cutoff = formData.age < 65 ? 325 : 340;
        document.getElementById('flow1_corr').textContent = 
          corr.toFixed(1) + ' мс (отсечка ' + cutoff + ' мс)';
        formData.b1_time           = t;
        formData.b1_hr             = hr;
        formData.b1_time_corrected = corr;
      }
    });

    // TODO: Привязать все остальные поля (blocks 2–6) тем же образом...

    // LUS-баллы
    function calcLus(prefix, scoreField, scoreElem) {
      let sum = 0;
      for (let i = 1; i <= 6; i++) {
        sum += parseInt(document.getElementById(prefix + i).value, 10) || 0;
      }
      formData[scoreField] = sum;
      document.getElementById(scoreElem).textContent = 
        'БАЛЛЫ ПО LUS – ' + sum;
    }
    ['lus_r','lus_l','lus6_r','lus6_l'].forEach(pref => {
      for (let i = 1; i <= 6; i++) {
        document.getElementById(pref + i).addEventListener('change', () => {
          if (pref.startsWith('lus6')) calcLus('lus6_r', 'lus6_score', 'lus6_score');
          else                           calcLus('lus_r', 'lus_score',   'lus_score');
        });
      }
    });

    // Обработчик «Завершить»
    document.querySelectorAll('.submit').forEach(btn => {
      btn.addEventListener('click', async () => {
        console.log('DEBUG ▶ click submit, block=', btn.dataset.block);
        stopTimer();
        formData.telegram_id = webApp.initDataUnsafe.user.id;
        // Собрать флаги err и LUS-флаги
        if (formData.block === '5') {
          formData.lus_error = document.getElementById('lus5_err').checked;
          ['lus_r_cons','lus_r_pneumo','lus_r_hydro',
           'lus_l_cons','lus_l_pneumo','lus_l_hydro']
            .forEach(id => formData[id] = document.getElementById(id).checked);
          calcLus('lus_r', 'lus_score', 'lus_score');
        }
        if (formData.block === '6') {
          formData.lus6_err = document.getElementById('lus6_err').checked;
          ['lus6_r_cons','lus6_r_pneumo','lus6_r_hydro',
           'lus6_l_cons','lus6_l_pneumo','lus6_l_hydro']
            .forEach(id => formData[id] = document.getElementById(id).checked);
          calcLus('lus6_r', 'lus6_score', 'lus6_score');
        }

        console.log('DEBUG ▶ formData=', formData);
        try {
          const res = await fetch(WEBHOOK_URL + '?data=' + 
            encodeURIComponent(JSON.stringify(formData)), {
              method: 'GET'
            });
          console.log('DEBUG ▶ fetch OK', res);
        } catch (err) {
          console.error('ERROR ▶ fetch failed', err);
          alert('Ошибка при сохранении: ' + err.message);
          return;
        }

        alert('✔️ Данные сохранены, время: ' + formData.total_time + ' сек.');
        webApp.close();
      });
    });

  }); // end DOMContentLoaded
</script>

</body>
</html>
