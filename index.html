<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чек-лист УЗ-мониторинга</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      padding-top: 60px;     /* место под таймер */
      padding-bottom: 200px; /* место под клавиатуру */
      background-color: #f4f4f4;
    }
    .timer {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #0088cc;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      font-size: 18px;
      font-weight: bold;
      z-index: 1000;
    }
    .hidden { display: none; }
    .section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    h2, h3 { margin-top: 0; }
    label { display: block; margin: 8px 0 4px; }
    input[type="text"], input[type="number"], select {
      width: 100%; padding: 8px; margin-bottom: 12px; box-sizing: border-box;
    }
    button {
      padding: 10px 20px; margin: 6px 4px 0 0;
      border: none; border-radius: 5px; background: #0088cc; color: #fff;
      font-size: 16px; cursor: pointer;
    }
    button.secondary { background: #666; }
    p.result { font-weight: bold; margin: 4px 0 12px; }
  </style>
</head>
<body>
  <!-- Таймер -->
  <div id="timer" class="timer hidden">00:00</div>

  <!-- Шаг 1: Исходные данные -->
  <div id="step1" class="section">
    <h2>Исходные данные</h2>
    <label for="block_select">Выберите блок:</label>
    <select id="block_select">
      <option value="1">Блок 1</option>
      <option value="2">Блок 2</option>
      <option value="3">Блок 3</option>
      <option value="4">Блок 4</option>
    </select>

    <label for="patient_id">Номер ИБ (ID пациента):</label>
    <input type="text" id="patient_id" placeholder="ID пациента">

    <label for="patient_age">Возраст пациента:</label>
    <input type="number" id="patient_age" placeholder="Лет">

    <button type="button" id="step1_next">Далее</button>
  </div>

  <!-- Шаг 2: Блок 1 -->
  <div id="block1_form" class="section hidden">
    <h2>Блок 1: Вена и артерия</h2>

    <!-- IJV -->
    <h3>Вариабельность диаметра внутренней яремной вены при дыхании</h3>
    <label for="ven_max">Max (мм):</label>
    <input type="number" id="ven_max" step="0.1">
    <label for="ven_min">Min (мм):</label>
    <input type="number" id="ven_min" step="0.1">
    <p id="ven_ratio_result" class="result"></p>
    <label><input type="checkbox" id="ven_error"> Технические погрешности</label>

    <!-- CCA -->
    <h3>Вариабельность диаметра общей сонной артерии при дыхании</h3>
    <label for="car_max">Max (мм):</label>
    <input type="number" id="car_max" step="0.1">
    <label for="car_min">Min (мм):</label>
    <input type="number" id="car_min" step="0.1">
    <p id="car_ratio_result" class="result"></p>
    <label><input type="checkbox" id="car_error"> Технические погрешности</label>

    <!-- Flow time -->
    <h3>Корректированное время потока на общей сонной артерии</h3>
    <label for="flow_time">Время (мс):</label>
    <input type="number" id="flow_time" step="0.1">
    <label for="heart_rate">ЧСС:</label>
    <input type="number" id="heart_rate">
    <p id="time_corrected_result" class="result"></p>
    <label><input type="checkbox" id="time_error"> Технические погрешности</label>

    <!-- Навигация -->
    <button type="button" class="secondary" id="step1_back">Назад</button>
    <button type="button" id="submit_button">Завершить</button>
  </div>

  <script>
    const webApp = Telegram.WebApp;
    webApp.ready();

    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbw39yAwIo2TuPUQfYFYjmzZur1i6mD_ZKP-Jv01izL3X4F3SI34lyp2OygkGIJmXI7N/exec";
    const formData = {};

    let timerInterval, startTime;

    // Увеличиваем padding-bottom при фокусе, чтобы не перекрывала клавиатура
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('focus', () => el.scrollIntoView({ behavior: 'smooth', block: 'center' }));
    });

    function startTimer() {
      startTime = Date.now();
      document.getElementById('timer').classList.remove('hidden');
      timerInterval = setInterval(updateTimer, 1000);
    }
    function stopTimer() {
      clearInterval(timerInterval);
      const totalSec = Math.floor((Date.now() - startTime) / 1000);
      formData.total_time = totalSec;  // в секундах
    }
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const m = String(Math.floor(elapsed / 60)).padStart(2,'0');
      const s = String(elapsed % 60).padStart(2,'0');
      document.getElementById('timer').textContent = `${m}:${s}`;
    }

    // Переход с Шага 1 на Блок 1
    document.getElementById('step1_next').addEventListener('click', () => {
      formData.block      = document.getElementById('block_select').value;
      formData.patient_id = document.getElementById('patient_id').value.trim();
      formData.age        = parseInt(document.getElementById('patient_age').value, 10);

      if (!formData.patient_id) { alert("Введите номер ИБ пациента"); return; }
      if (isNaN(formData.age))   { alert("Введите возраст пациента");       return; }

      document.getElementById('step1').classList.add('hidden');
      document.getElementById('block1_form').classList.remove('hidden');
      startTimer();
    });

    // Кнопка «Назад»
    document.getElementById('step1_back').addEventListener('click', () => {
      document.getElementById('block1_form').classList.add('hidden');
      document.getElementById('step1').classList.remove('hidden');
      clearInterval(timerInterval);
      document.getElementById('timer').classList.add('hidden');
    });

    // Расчёты (IJV, CCA, Time) — без изменений…
    function updateVenRatio() { /* как раньше */ }
    function updateCarRatio() { /* как раньше */ }
    function updateTimeCorrected() { /* как раньше */ }
    ven_max.addEventListener('input', updateVenRatio);
    ven_min.addEventListener('input', updateVenRatio);
    car_max.addEventListener('input', updateCarRatio);
    car_min.addEventListener('input', updateCarRatio);
    flow_time.addEventListener('input', updateTimeCorrected);
    heart_rate.addEventListener('input', updateTimeCorrected);

    // Отправка и остановка таймера
    document.getElementById('submit_button').addEventListener('click', async () => {
      if (formData.b1_ven_max == null || formData.b1_ven_min == null) { alert("Заполните Max и Min внутренней яремной вены"); return; }
      if (formData.b1_car_max == null || formData.b1_car_min == null) { alert("Заполните Max и Min общей сонной артерии"); return; }
      if (formData.b1_time == null || formData.b1_hr == null)       { alert("Заполните время потока и ЧСС"); return; }

      stopTimer();
      formData.telegram_id = webApp.initDataUnsafe.user.id;

      const url = WEBHOOK_URL + '?data=' + encodeURIComponent(JSON.stringify(formData));
      await fetch(url, { method: 'GET', mode: 'no-cors' });

      alert("✔️ Данные сохранены в таблицу\nОбщее время: " + formData.total_time + " сек.");
      webApp.close();
    });
  </script>
</body>
</html>
