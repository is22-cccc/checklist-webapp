<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чек-лист УЗ-мониторинга</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      padding-top: 60px;     /* место под таймер */
      padding-bottom: 200px; /* место под клавиатуру */
      background-color: #f4f4f4;
    }
    .timer {
      position: fixed; top:0; left:0; right:0;
      background:#0088cc; color:#fff;
      text-align:center; padding:10px 0;
      font-size:18px; font-weight:bold;
      z-index:1000;
    }
    .hidden { display:none }
    .section {
      background:#fff; padding:15px;
      border-radius:8px; margin-bottom:20px;
    }
    h2,h3 { margin-top:0 }
    label { display:block; margin:8px 0 4px }
    input, select { width:100%; padding:8px; margin-bottom:12px; box-sizing:border-box }
    button {
      padding:10px 20px; margin:6px 4px 0 0;
      border:none; border-radius:5px;
      background:#0088cc; color:#fff;
      font-size:16px; cursor:pointer;
    }
    button.secondary { background:#666 }
    p.result { font-weight:bold; margin:4px 0 12px }
  </style>
</head>
<body>
  <!-- Таймер -->
  <div id="timer" class="timer hidden">00:00</div>

  <!-- Шаг 1 -->
  <div id="step1" class="section">
    <h2>Исходные данные</h2>
    <label>Выберите блок:</label>
    <select id="block_select">
      <option value="1">Блок 1</option>
      <option value="2">Блок 2</option>
      <option value="3">Блок 3</option>
      <option value="4">Блок 4</option>
    </select>
    <label>Номер И/Б:</label>
    <input type="text" id="patient_id" placeholder="ID пациента">
    <label>Возраст пациента:</label>
    <input type="number" id="patient_age" placeholder="Лет">
    <button id="next1">Далее</button>
  </div>

  <!-- Блок 1 -->
  <div id="form1" class="section hidden">
    <h2>Внутренняя яремная вена и сонная артерия</h2>

    <h3>Вариабельность диаметра внутренней яремной вены при дыхании</h3>
    <label>Max (мм):<input type="number" id="ven_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="ven_min" step="0.1"></label>
    <p id="ven_ratio" class="result"></p>
    <label><input type="checkbox" id="ven_err"> Технические погрешности</label>

    <h3>Вариабельность диаметра общей сонной артерии при дыхании</h3>
    <label>Max (мм):<input type="number" id="car_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="car_min" step="0.1"></label>
    <p id="car_ratio" class="result"></p>
    <label><input type="checkbox" id="car_err"> Технические погрешности</label>

    <h3>Корректированное время потока на общей сонной артерии</h3>
    <label>Время (мс):<input type="number" id="flow_time" step="0.1"></label>
    <label>ЧСС:<input type="number" id="hr"></label>
    <p id="time_corr" class="result"></p>
    <label><input type="checkbox" id="time_err"> Технические погрешности</label>

    <button class="secondary back" data-from="1">Назад</button>
    <button class="submit" data-block="1">Завершить</button>
  </div>

  <!-- Блок 2 -->
  <div id="form2" class="section hidden">
    <h2>Блок 2: + плеч. артерия и НПВ</h2>

    <!-- Повтор блока 1 -->
    <h3>Вариабельность диаметра внутренней яремной вены при дыхании</h3>
    <label>Max (мм):<input type="number" id="ven2_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="ven2_min" step="0.1"></label>
    <p id="ven2_ratio" class="result"></p>
    <label><input type="checkbox" id="ven2_err"> Технические погрешности</label>

    <h3>Вариабельность диаметра общей сонной артерии при дыхании</h3>
    <label>Max (мм):<input type="number" id="car2_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="car2_min" step="0.1"></label>
    <p id="car2_ratio" class="result"></p>
    <label><input type="checkbox" id="car2_err"> Технические погрешности</label>

    <h3>Корректированное время потока на общей сонной артерии</h3>
    <label>Время (мс):<input type="number" id="flow2_time" step="0.1"></label>
    <label>ЧСС:<input type="number" id="hr2"></label>
    <p id="time2_corr" class="result"></p>
    <label><input type="checkbox" id="time2_err"> Технические погрешности</label>

    <!-- Дополнительно -->
    <h3>Вариабельность пиковой скорости на плечевой артерии</h3>
    <label>Max (см/с):<input type="number" id="brach_max" step="0.1"></label>
    <label>Min (см/с):<input type="number" id="brach_min" step="0.1"></label>
    <p id="brach_ratio" class="result"></p>
    <label><input type="checkbox" id="brach_err"> Технические погрешности</label>

    <h3>Вариабельность диаметра нижней полой вены</h3>
    <label>Max (мм):<input type="number" id="ivc_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="ivc_min" step="0.1"></label>
    <p id="ivc_ratio" class="result"></p>
    <label><input type="checkbox" id="ivc_err"> Технические погрешности</label>

    <button class="secondary back" data-from="2">Назад</button>
    <button class="submit" data-block="2">Завершить</button>
  </div>

  <!-- Блок 3 -->
  <div id="form3" class="section hidden">
    <h2>Блок 3: VTI LVOT и VTI PA</h2>

    <h3>Вариабельность VTI на выносящем тракте ЛЖ</h3>
    <label>Max (см):<input type="number" id="lvot_max" step="0.1"></label>
    <label>Min (см):<input type="number" id="lvot_min" step="0.1"></label>
    <p id="lvot_ratio" class="result"></p>
    <label><input type="checkbox" id="lvot_err"> Технические погрешности</label>

    <h3>Вариабельность VTI на легочной артерии</h3>
    <label>Max (см):<input type="number" id="pa_max" step="0.1"></label>
    <label>Min (см):<input type="number" id="pa_min" step="0.1"></label>
    <p id="pa_ratio" class="result"></p>
    <label><input type="checkbox" id="pa_err"> Технические погрешности</label>

    <button class="secondary back" data-from="3">Назад</button>
    <button class="submit" data-block="3">Завершить</button>
  </div>

  <!-- Блок 4 -->
  <div id="form4" class="section hidden">
    <h2>Блок 4: Все показатели</h2>

    <!-- Секция IJV -->
    <h3>Вариабельность диаметра внутренней яремной вены при дыхании</h3>
    <label>Max:<input type="number" id="ven4_max" step="0.1"></label>
    <label>Min:<input type="number" id="ven4_min" step="0.1"></label>
    <p id="ven4_ratio" class="result"></p>
    <label><input type="checkbox" id="ven4_err"> Тех. погрешности</label>

    <!-- CCA -->
    <h3>Вариабельность диаметра общей сонной артерии при дыхании</h3>
    <label>Max:<input type="number" id="car4_max" step="0.1"></label>
    <label>Min:<input type="number" id="car4_min" step="0.1"></label>
    <p id="car4_ratio" class="result"></p>
    <label><input type="checkbox" id="car4_err"> Тех. погрешности</label>

    <!-- Flow -->
    <h3>Корректированное время потока на общей сонной артерии</h3>
    <label>Время:<input type="number" id="flow4_time" step="0.1"></label>
    <label>ЧСС:<input type="number" id="hr4"></label>
    <p id="time4_corr" class="result"></p>
    <label><input type="checkbox" id="time4_err"> Тех. погрешности</label>

    <!-- Brachial -->
    <h3>Вариабельность пиковой скорости на плечевой артерии</h3>
    <label>Max:<input type="number" id="brach4_max" step="0.1"></label>
    <label>Min:<input type="number" id="brach4_min" step="0.1"></label>
    <p id="brach4_ratio" class="result"></p>
    <label><input type="checkbox" id="brach4_err"> Тех. погрешности</label>

    <!-- IVC -->
    <h3>Вариабельность диаметра нижней полой вены</h3>
    <label>Max:<input type="number" id="ivc4_max" step="0.1"></label>
    <label>Min:<input type="number" id="ivc4_min" step="0.1"></label>
    <p id="ivc4_ratio" class="result"></p>
    <label><input type="checkbox" id="ivc4_err"> Тех. погрешности</label>

    <!-- LVOT VTI -->
    <h3>Вариабельность VTI на выносящем тракте ЛЖ</h3>
    <label>Max:<input type="number" id="lvot4_max" step="0.1"></label>
    <label>Min:<input type="number" id="lvot4_min" step="0.1"></label>
    <p id="lvot4_ratio" class="result"></p>
    <label><input type="checkbox" id="lvot4_err"> Тех. погрешности</label>

    <!-- PA VTI -->
    <h3>Вариабельность VTI на легочной артерии</h3>
    <label>Max:<input type="number" id="pa4_max" step="0.1"></label>
    <label>Min:<input type="number" id="pa4_min" step="0.1"></label>
    <p id="pa4_ratio" class="result"></p>
    <label><input type="checkbox" id="pa4_err"> Тех. погрешности</label>

    <button class="secondary back" data-from="4">Назад</button>
    <button class="submit" data-block="4">Завершить</button>
  </div>

  <script>
    const webApp = Telegram.WebApp; webApp.ready();
    const urlExec = 'https://script.google.com/macros/s/…/exec';
    const formData = {};
    let timerInterval, startTime;

    // utilities
    function scroll(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); }
    document.querySelectorAll('input,select').forEach(i=>i.addEventListener('focus',()=>scroll(i)));

    function startTimer(){
      startTime = Date.now();
      document.getElementById('timer').classList.remove('hidden');
      timerInterval = setInterval(()=>{
        const sec = Math.floor((Date.now()-startTime)/1000),
              m = String(Math.floor(sec/60)).padStart(2,'0'),
              s = String(sec%60).padStart(2,'0');
        document.getElementById('timer').textContent = `${m}:${s}`;
      },1000);
    }
    function stopTimer(){
      clearInterval(timerInterval);
      formData.total_time = Math.floor((Date.now()-startTime)/1000);
    }

    // переходы
    document.getElementById('next1').onclick = ()=>{
      formData.block = document.getElementById('block_select').value;
      formData.patient_id = document.getElementById('patient_id').value.trim();
      formData.age = parseInt(document.getElementById('patient_age').value,10);
      if(!formData.patient_id||isNaN(formData.age)){ alert('Заполните ID и возраст'); return }
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('form'+formData.block).classList.remove('hidden');
      startTimer();
    };
    document.querySelectorAll('.back').forEach(btn=>{
      btn.onclick = ()=> {
        const b=btn.dataset.from;
        document.getElementById('form'+b).classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
        clearInterval(timerInterval);
        document.getElementById('timer').classList.add('hidden');
      };
    });

    // расчёты
    function bindCalc(maxId,minId,resId, fieldMax, fieldMin, fieldRatio, cutoffText){
      function upd(){
        const mx=parseFloat(document.getElementById(maxId).value),
              mn=parseFloat(document.getElementById(minId).value);
        if(!isNaN(mx)&&!isNaN(mn)){
          const r = (mx-mn)/((mx+mn)/2)*100;
          document.getElementById(resId).textContent = r.toFixed(1)+'% ' + cutoffText;
          formData[fieldMax]=mx;
          formData[fieldMin]=mn;
          formData[fieldRatio]=r;
        }
      }
      document.getElementById(maxId).addEventListener('input',upd);
      document.getElementById(minId).addEventListener('input',upd);
    }

    // блок 1
    bindCalc('ven_max','ven_min','ven_ratio','b1_ven_max','b1_ven_min','b1_ven_ratio','(отсечка 18%)');
    bindCalc('car_max','car_min','car_ratio','b1_car_max','b1_car_min','b1_car_ratio','(отсечка 12%)');
    // flow time
    document.getElementById('flow_time').addEventListener('input',()=>{
      const t=parseFloat(document.getElementById('flow_time').value),
            hr=parseInt(document.getElementById('hr').value,10);
      if(!isNaN(t)&&!isNaN(hr)){
        const corr = t + 1.3*(hr-60),
              cutoff = formData.age<65?325:340;
        document.getElementById('time_corr').textContent = corr.toFixed(1)+' мс (отсечка '+cutoff+' мс)';
        formData.b1_time = t; formData.b1_hr = hr; formData.b1_time_corrected = corr;
      }
    });

    // блок 2
    bindCalc('ven2_max','ven2_min','ven2_ratio','b2_ven_max','b2_ven_min','b2_ven_ratio','(отсечка 18%)');
    bindCalc('car2_max','car2_min','car2_ratio','b2_car_max','b2_car_min','b2_car_ratio','(отсечка 12%)');
    document.getElementById('flow2_time').addEventListener('input',()=>{
      const t=parseFloat(document.getElementById('flow2_time').value),
            hr=parseInt(document.getElementById('hr2').value,10);
      if(!isNaN(t)&&!isNaN(hr)){
        const corr = t + 1.3*(hr-60),
              cutoff = formData.age<65?325:340;
        document.getElementById('time2_corr').textContent = corr.toFixed(1)+' мс (отсечка '+cutoff+' мс)';
        formData.b2_time = t; formData.b2_hr = hr; formData.b2_time_corrected = corr;
      }
    });
    bindCalc('brach_max','brach_min','brach_ratio','b2_brachial_max','b2_brachial_min','b2_brachial_ratio','');
    bindCalc('ivc_max','ivc_min','ivc_ratio','b2_ivc_max','b2_ivc_min','b2_ivc_ratio','');

    // блок 3
    bindCalc('lvot_max','lvot_min','lvot_ratio','b3_lvot_max','b3_lvot_min','b3_lvot_ratio','');
    bindCalc('pa_max','pa_min','pa_ratio','b3_pa_max','b3_pa_min','b3_pa_ratio','');

    // Блок 4: повторяем все поля из 1,2,3, даем новые id (ven4_..., car4_..., flow4_time, hr4, lvot4_..., pa4_...)
    bindCalc('ven4_max','ven4_min','ven4_ratio','b4_ven_max','b4_ven_min','b4_ven_ratio','(отсечка 18%)');
    bindCalc('car4_max','car4_min','car4_ratio','b4_car_max','b4_car_min','b4_car_ratio','(отсечка 12%)');
    document.getElementById('flow4_time').addEventListener('input',()=>{
      const t=parseFloat(document.getElementById('flow4_time').value),
            hr=parseInt(document.getElementById('hr4').value,10);
      if(!isNaN(t)&&!isNaN(hr)){
        const corr = t + 1.3*(hr-60),
              cutoff = formData.age<65?325:340;
        document.getElementById('time4_corr').textContent = corr.toFixed(1)+' мс (отсечка '+cutoff+' мс)';
        formData.b4_time = t; formData.b4_hr = hr; formData.b4_time_corrected = corr;
      }
    });
    bindCalc('brach4_max','brach4_min','brach4_ratio','b4_brachial_max','b4_brachial_min','b4_brachial_ratio','');
    bindCalc('ivc4_max','ivc4_min','ivc4_ratio','b4_ivc_max','b4_ivc_min','b4_ivc_ratio','');
    bindCalc('lvot4_max','lvot4_min','lvot4_ratio','b4_lvot_max','b4_lvot_min','b4_lvot_ratio','');
    bindCalc('pa4_max','pa4_min','pa4_ratio','b4_pa_max','b4_pa_min','b4_pa_ratio','');

    // отправка
    document.querySelectorAll('.submit').forEach(btn=>{
      btn.onclick = async ()=>{
        stopTimer();
        formData.telegram_id = webApp.initDataUnsafe.user.id;
        formData.block = btn.dataset.block;
        ['ven_err','car_err','time_err'] .forEach(id=>formData[id]=document.getElementById(id + (formData.block>1?'2':'')).checked);
        // аналогично для каждого блока: ven2_err,car2_err,time2_err,brach_err,ivc_err,lvot_err,pa_err, и их 4-ые варианты…
        const payload = encodeURIComponent(JSON.stringify(formData));
        await fetch(urlExec + '?data=' + payload, {method:'GET', mode:'no-cors'});
        alert('✔️ Сохранено, время: ' + formData.total_time + ' сек.');
        webApp.close();
      };
    });
  </script>
</body>
</html>
