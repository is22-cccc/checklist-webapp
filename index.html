<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Чек-лист УЗ-мониторинга</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      padding-top: 60px;
      padding-bottom: 200px;
      background: #f4f4f4;
    }
    .timer {
      position: fixed; top:0; left:0; right:0;
      background:#0088cc; color:#fff;
      text-align:center; padding:10px 0;
      font-size:18px; font-weight:bold;
      z-index:1000;
    }
    .hidden { display:none; }
    .section {
      background:#fff; padding:15px;
      border-radius:8px; margin-bottom:20px;
    }
    label { display:block; margin:8px 0 4px; }
    input,select { width:100%; padding:8px; margin-bottom:12px; }
    button {
      padding:10px 20px; margin:6px 4px 0 0;
      border:none; border-radius:5px; background:#0088cc; color:#fff;
      font-size:16px; cursor:pointer;
    }
    button.secondary { background:#666; }
    p.result { font-weight:bold; margin:4px 0 12px; }
  </style>
</head>
<body>
  <div id="timer" class="timer hidden">00:00</div>

  <!-- Шаг 1: выбор блока -->
  <div id="step1" class="section">
    <h2>Исходные данные</h2>
    <label>Выберите блок:</label>
    <select id="block_select">
      <option value="1">Блок 1</option>
      <option value="2">Блок 2</option>
      <option value="3">Блок 3</option>
      <option value="4">Блок 4</option>
    </select>
    <label>Номер И/Б (ID пациента):</label>
    <input type="text" id="patient_id" placeholder="ID пациента">
    <label>Возраст пациента:</label>
    <input type="number" id="patient_age" placeholder="Лет">
    <button id="step1_next">Далее</button>
  </div>

  <!-- Форма Блока 1 -->
  <div id="form1" class="section hidden">
    <h2>Блок 1: IJV, CCA, Flow time</h2>
    <!-- IJV -->
    <h3>IJV вариабельность</h3>
    <label>Max (мм):<input type="number" id="ven_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="ven_min" step="0.1"></label>
    <p id="ven_ratio_result" class="result"></p>
    <label><input type="checkbox" id="ven_error"> Тех. погрешности</label>
    <!-- CCA -->
    <h3>CCA вариабельность</h3>
    <label>Max (мм):<input type="number" id="car_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="car_min" step="0.1"></label>
    <p id="car_ratio_result" class="result"></p>
    <label><input type="checkbox" id="car_error"> Тех. погрешности</label>
    <!-- Flow time -->
    <h3>Flow time коррект.</h3>
    <label>Время (мс):<input type="number" id="flow_time" step="0.1"></label>
    <label>ЧСС:<input type="number" id="heart_rate"></label>
    <p id="time_corrected_result" class="result"></p>
    <label><input type="checkbox" id="time_error"> Тех. погрешности</label>

    <button class="secondary" id="back1">Назад</button>
    <button class="submit" data-block="1">Завершить</button>
  </div>

  <!-- Форма Блока 2 -->
  <div id="form2" class="section hidden">
    <h2>Блок 2: Всё из 1 + Brachial, IVC</h2>
    <!-- Повторяем поля IJV,CCA,Flow как в form1... -->
    <!-- затем Brachial -->
    <h3>Brachial вариабельность</h3>
    <label>Max (мм):<input type="number" id="brachial_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="brachial_min" step="0.1"></label>
    <p id="brachial_ratio_result" class="result"></p>
    <label><input type="checkbox" id="brachial_error"> Тех. погрешности</label>
    <!-- затем IVC -->
    <h3>IVC вариабельность</h3>
    <label>Max (мм):<input type="number" id="ivc_max" step="0.1"></label>
    <label>Min (мм):<input type="number" id="ivc_min" step="0.1"></label>
    <p id="ivc_ratio_result" class="result"></p>
    <label><input type="checkbox" id="ivc_error"> Тех. погрешности</label>

    <button class="secondary" id="back2">Назад</button>
    <button class="submit" data-block="2">Завершить</button>
  </div>

  <!-- Форма Блока 3 -->
  <div id="form3" class="section hidden">
    <h2>Блок 3: VTI LVOT, VTI PA</h2>
    <h3>VTI LVOT вариабельность</h3>
    <label>Max:<input type="number" id="lvot_max" step="0.1"></label>
    <label>Min:<input type="number" id="lvot_min" step="0.1"></label>
    <p id="lvot_ratio_result" class="result"></p>
    <label><input type="checkbox" id="lvot_error"> Тех. погрешности</label>

    <h3>VTI PA вариабельность</h3>
    <label>Max:<input type="number" id="pa_max" step="0.1"></label>
    <label>Min:<input type="number" id="pa_min" step="0.1"></label>
    <p id="pa_ratio_result" class="result"></p>
    <label><input type="checkbox" id="pa_error"> Тех. погрешности</label>

    <button class="secondary" id="back3">Назад</button>
    <button class="submit" data-block="3">Завершить</button>
  </div>

  <!-- Форма Блока 4 -->
  <div id="form4" class="section hidden">
    <h2>Блок 4: Все показатели</h2>
    <!-- Вложите сюда все поля из form2 и form3 подряд -->
    <!-- ... -->
    <button class="secondary" id="back4">Назад</button>
    <button class="submit" data-block="4">Завершить</button>
  </div>

<script>
  const webApp = Telegram.WebApp; webApp.ready();
  const formData = {}, WEBHOOK_URL = 'https://script.google.com/macros/s/.../exec';
  let timerInterval, startTime;

  function scrollTo(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); }
  document.querySelectorAll('input,select').forEach(i=>i.addEventListener('focus', ()=>scrollTo(i)));

  function startTimer(){ startTime=Date.now(); 
    document.getElementById('timer').classList.remove('hidden');
    timerInterval=setInterval(updateTimer,1000);
  }
  function stopTimer(){ clearInterval(timerInterval);
    formData.total_time=Math.floor((Date.now()-startTime)/1000);
  }
  function updateTimer(){
    const e=Math.floor((Date.now()-startTime)/1000),m=String(Math.floor(e/60)).padStart(2,'0'),s=String(e%60).padStart(2,'0');
    document.getElementById('timer').textContent=`${m}:${s}`;
  }

  document.getElementById('step1_next').onclick = ()=>{
    formData.block=document.getElementById('block_select').value;
    formData.patient_id=document.getElementById('patient_id').value.trim();
    formData.age=parseInt(document.getElementById('patient_age').value,10);
    if(!formData.patient_id||isNaN(formData.age)){ alert('Заполните ID и возраст'); return; }
    document.getElementById('step1').classList.add('hidden');
    document.getElementById('form'+formData.block).classList.remove('hidden');
    startTimer();
  };
  ['back1','back2','back3','back4'].forEach(id=>{
    document.getElementById(id).onclick=()=>{
      const b=id.slice(-1);
      document.getElementById('form'+b).classList.add('hidden');
      document.getElementById('step1').classList.remove('hidden');
      clearInterval(timerInterval);
      document.getElementById('timer').classList.add('hidden');
    };
  });

  // Общая функция для расчёта ratio
  function bindRatio(maxId,minId,resId,fdKeyMax,fdKeyMin,fdKeyRatio,cutoff){
    const upd=()=>{
      const mx=parseFloat(document.getElementById(maxId).value), mn=parseFloat(document.getElementById(minId).value);
      if(!isNaN(mx)&&!isNaN(mn)){
        const r=(mx-mn)/((mx+mn)/2)*100;
        document.getElementById(resId).textContent=r.toFixed(1)+'% (отсечка '+cutoff+'%)';
        formData[fdKeyMax]=mx; formData[fdKeyMin]=mn; formData[fdKeyRatio]=r;
      }
    };
    document.getElementById(maxId).addEventListener('input',upd);
    document.getElementById(minId).addEventListener('input',upd);
  }

  // Биндим все поля:
  bindRatio('ven_max','ven_min','ven_ratio_result','b1_ven_max','b1_ven_min','b1_ven_ratio',18);
  bindRatio('car_max','car_min','car_ratio_result','b1_car_max','b1_car_min','b1_car_ratio',12);
  bindRatio('flow_time','heart_rate','time_corrected_result','b1_time','b1_hr','b1_time_corrected', formData.age<65?325:340);
  bindRatio('brachial_max','brachial_min','brachial_ratio_result','b2_brachial_max','b2_brachial_min','b2_brachial_ratio', /* ваш cutoff */  );
  bindRatio('ivc_max','ivc_min','ivc_ratio_result','b2_ivc_max','b2_ivc_min','b2_ivc_ratio', /* cutoff */ );
  bindRatio('lvot_max','lvot_min','lvot_ratio_result','b3_lvot_max','b3_lvot_min','b3_lvot_ratio', /*cutoff*/ );
  bindRatio('pa_max','pa_min','pa_ratio_result','b3_pa_max','b3_pa_min','b3_pa_ratio', /*cutoff*/ );

  // Обработка отправки
  document.querySelectorAll('.submit').forEach(btn=>{
    btn.onclick=async()=>{
      const blk=btn.dataset.block;
      // валидация по блоку, пропустим для краткости
      stopTimer();
      formData.telegram_id = webApp.initDataUnsafe.user.id;
      formData.block=blk;
      const url=WEBHOOK_URL+'?data='+encodeURIComponent(JSON.stringify(formData));
      await fetch(url,{method:'GET',mode:'no-cors'});
      alert('✔️ Данные сохранены\nВремя:'+formData.total_time+' с');
      webApp.close();
    };
  });
</script>
</body>
</html>
